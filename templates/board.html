

{% extends "base.html" %}
{% block title %}íŒ€ ê²Œì‹œíŒ{% endblock %}
{% block content %}
<style>
  :root{
    --ink:#111827;          /* text */
    --muted:#6b7280;        /* secondary text */
    --line:#e6e8eb;         /* borders */
    --bg:#f7f8fb;           /* page bg */
    --card:#ffffff;         /* surfaces */
    --accent:#10b981;       /* green accent */
    --me:#0f172a;           /* my bubble */
  }
  .board-page{max-width:980px;margin:0 auto;padding:24px}
  .board-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .board-title{display:flex;align-items:center;gap:10px}
  .board-title h2{margin:0;font-size:1.35rem;color:var(--ink)}
  .board-sub{color:var(--muted);font-size:.92rem}
  .board-actions{display:flex;align-items:center;gap:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:var(--card);padding:8px 12px;border-radius:10px;color:var(--ink);text-decoration:none}
  .btn:hover{border-color:#d7d9de}

  .chat-card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .chat-scroll{max-height:62vh;overflow:auto;padding:16px}
  .day-sep{position:sticky;top:0;z-index:1;display:flex;justify-content:center;margin:8px 0}
  .day-sep span{background:#f1f3f7;color:#4b5563;border:1px solid var(--line);font-size:.78rem;padding:4px 10px;border-radius:999px}

  .msg{display:flex;gap:10px;margin:8px 0}
  .msg.me{flex-direction:row-reverse}
  .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--line);background:#fff}
  .bubble{max-width:70%;border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#f5f7fb}
  .msg.me .bubble{background:var(--me);color:#fff;border-color:#0b1229}
  .meta{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:.82rem;color:var(--muted)}
  .msg.me .meta{color:#c7d2fe}
  .username{font-weight:700;color:#1f2937}
  .msg.me .username{color:#e5e7eb}
  .time{font-variant-numeric:tabular-nums}
  .content{white-space:pre-wrap;word-break:break-word}

  .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:linear-gradient(#fafbfe, #f6f7fb)}
  .composer .me-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--line);background:#fff}
  .composer form{display:flex;gap:10px;flex:1}
  .composer textarea{flex:1;min-height:56px;max-height:200px;border:1px solid var(--line);border-radius:12px;padding:12px 14px;resize:vertical;font-size:14px}
  .composer .right{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .counter{font-size:.8rem;color:var(--muted)}
  .send{border:none;background:var(--accent);color:#fff;padding:10px 16px;border-radius:12px;cursor:pointer}
  .send:disabled{opacity:.5;cursor:not-allowed}

  /* make page background subtle if base.html doesn't set it */
  body{background:var(--bg)}
</style>

<div class="board-page">
  <div class="board-header">
    <div class="board-title">
      <h2>íŒ€ ê²Œì‹œíŒ</h2>
      <div class="board-sub">ì´ ë‹¬ì˜ ë°©ëª…ë¡ Â· ì›”ë³„ë¡œ ìë™ ì´ˆê¸°í™”</div>
    </div>
    <div class="board-actions">
      <a class="btn" href="{{ url_for('board') }}">ğŸ”„ ìƒˆë¡œê³ ì¹¨</a>
    </div>
  </div>

  <div class="chat-card">
    <div id="chat" class="chat-scroll">
      {# ë‚ ì§œ êµ¬ë¶„ì„  ì¶œë ¥ìš© #}
      {% set _prev_date = None %}
      {% for m in messages %}
        {% set day = m['created_at'][:10] if m['created_at'] else '' %}
        {% if day != _prev_date %}
          <div class="day-sep"><span>{{ day }}</span></div>
          {% set _prev_date = day %}
        {% endif %}

        {% set is_me = (session.get('username') == m['username']) %}
        <div class="msg {% if is_me %}me{% endif %}">
          {% if m['avatar_path'] %}
            <img class="avatar" src="/{{ m['avatar_path'] }}" alt="avatar">
          {% else %}
            <img class="avatar" src="/static/avatars/default.png" alt="avatar">
          {% endif %}
          <div class="bubble">
            <div class="meta">
              <span class="username">{{ m['username'] }}</span>
              <span class="time">{{ m['created_at'] }}</span>
            </div>
            <div class="content">{{ m['content']|e }}</div>
          </div>
        </div>
      {% else %}
        <div class="day-sep"><span>ì²« ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš” âœï¸</span></div>
      {% endfor %}
    </div>

    <div class="composer">
      {% if session.get('avatar_path') %}
        <img class="me-avatar" src="/{{ session['avatar_path'] }}" alt="me">
      {% else %}
        <img class="me-avatar" src="/static/avatars/default.png" alt="me">
      {% endif %}
      <form method="post" action="{{ url_for('board_post') }}" onsubmit="return allowSend();">
        <textarea id="msg" name="content" maxlength="280" placeholder="ì§§ì€ ë©”ëª¨ë‚˜ ê³µì§€, ì‘ì› í•œ ì¤„ (ìµœëŒ€ 280ì)"></textarea>
        <div class="right">
          <div class="counter"><span id="cnt">0</span>/280</div>
          <button id="send" class="send" type="submit" disabled>ë“±ë¡</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ìë™ ìŠ¤í¬ë¡¤: ê°€ì¥ ì•„ë˜ë¡œ
  const chat = document.getElementById('chat');
  if (chat) { chat.scrollTop = chat.scrollHeight; }

  // ê¸€ììˆ˜ ì¹´ìš´íŠ¸ & ë²„íŠ¼ í™œì„±í™”
  const ta = document.getElementById('msg');
  const cnt = document.getElementById('cnt');
  const send = document.getElementById('send');
  function update(){
    const len = (ta.value || '').trim().length;
    cnt.textContent = len;
    send.disabled = (len === 0 || len > 280);
  }
  function allowSend(){
    update();
    return !send.disabled;
  }
  ta.addEventListener('input', update);
  update();
</script>
{% endblock %}