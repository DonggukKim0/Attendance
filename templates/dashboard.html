<!doctype html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ€ ê²Œì‹œíŒ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
  .topnav {
    background-color: #111827;
    color: white;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    position: relative;
  }
  .topnav .menu {
    position: relative;
  }
  .topnav a {
    color: #e5e7eb;
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
  }
  .submenu {
    display: none;
    position: absolute;
    background-color: #1f2937;
    min-width: 180px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    z-index: 10;
    border-radius: 8px;
    padding: 8px 0;
  }
  .submenu a {
    display: block;
    padding: 8px 16px;
    color: #e5e7eb;
  }
  .submenu a:hover {
    background-color: #374151;
  }
  .menu:hover .submenu {
    display: block;
  }
  body { 
    margin: 0;
    background: #f5f6fa;
    font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', system-ui, sans-serif;
    color: #2b2e3a;
  }
  .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px 40px; }
  .layout { 
    display: grid; 
    grid-template-columns: minmax(0, 520px) minmax(0, 320px); 
    gap: 24px; 
    align-items: start; 
    justify-content: center;
  }
  .main { min-width: 0; }
  .side { min-width: 0; }
  .hello-card { background: linear-gradient(135deg, #4f6bed 0%, #7c93ff 100%); border-radius: 16px; box-shadow: 0 16px 32px rgba(40,50,130,0.28); color: #fff; padding: 20px 24px 24px; display: flex; flex-direction: column; position: relative; overflow: hidden; }
  .hello-top { font-size: 15px; font-weight: 500; opacity: 0.9; margin-bottom: 4px; }
  .hello-name { font-size: 20px; font-weight: 600; line-height: 1.3; display: flex; align-items: baseline; gap: 8px; color: #fff; }
  .pill-status { font-size: 12px; font-weight: 500; line-height: 1.4; border-radius: 999px; padding: 3px 8px; display: inline-flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.22); color: #fff; }
  .pill-dot { width: 8px; height: 8px; border-radius: 50%; background: #00ff85; box-shadow: 0 0 8px rgba(0,255,133,0.8); }
  .pill-dot.off { background: #ff4f4f; box-shadow: 0 0 8px rgba(255,79,79,0.8); }
  .hello-detail { font-size: 13px; font-weight: 400; margin-top: 12px; line-height: 1.5; color: rgba(255,255,255,0.9); }
  .stat-card, .section-card, .lucky-card { background: #fff; border-radius: 14px; box-shadow: 0 12px 28px rgba(0,0,0,0.07); padding: 16px 20px 18px; margin-top: 20px; }
  .stat-header, .lucky-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
  .stat-title, .lucky-title { font-size: 14px; color: #555a75; font-weight: 600; }
  .stat-time { font-size: 22px; font-weight: 600; color: #2b2e3a; }
  .punch-wrap { margin-top: 24px; display: flex; flex-direction: column; gap: 12px; }
  .punch-btn { border: none; width: 100%; border-radius: 10px; font-size: 16px; font-weight: 600; line-height: 1.3; padding: 14px 16px; cursor: pointer; color: #fff; background: linear-gradient(135deg, #00c36a 0%, #12d47e 100%); box-shadow: 0 10px 20px rgba(0,195,106,0.35); }
  .punch-btn.out { background: linear-gradient(135deg, #e14b4b 0%, #ff6b6b 100%); box-shadow: 0 10px 20px rgba(225,75,75,0.35); }
  .link-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 16px; font-size: 14px; line-height: 1.4; }
  .link-item a { text-decoration: none; color: #2b2e3a; font-weight: 500; display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; background: #f5f6fa; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03); transition: all 0.15s ease; }
  .link-item a:hover { background: #eef0ff; box-shadow: 0 8px 20px rgba(79,107,237,0.18); color: #4f6bed; }
  .foot-note { margin-top: 28px; font-size: 11px; text-align: center; color: #bbbccf; }
  .cal-nav { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .cal-title { font-size:16px; font-weight:700; color:#2b2e3a; }
  .cal-nav-btn { border:none; background:#f3f4f6; color:#111827; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .cal-nav-btn:hover { background:#e5e7eb; }
  .cal-cell.wknd:not(.worked) { background:#eef2f7; }
  .cal-cell.today { position:relative; }
  .cal-cell.today span { position:relative; z-index:1; }
  .cal-cell.today::after { content:""; position:absolute; inset:4px; border:2px solid #4f46e5; border-radius:10px; }

  .calendar-card { background:#fff; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,0.07); padding:16px 16px 18px; }
  .cal-weekdays { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin:6px 0 8px; font-size:12px; color:#6b7280; text-align:center; }
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .cal-cell { background:#f1f5f9; border:1px solid #e5e7eb; aspect-ratio:1/1; border-radius:10px; display:flex; align-items:center; justify-content:center; position:relative; }
  .cal-cell.blank { background:transparent; border:none; }
  .cal-cell.worked { color:#0b1b13; }
  .cal-cell > span { font-variant-numeric: tabular-nums; font-weight:600; font-size:12px; }
  .cal-legend { display:flex; align-items:center; gap:8px; margin-top:10px; font-size:12px; color:#6b7280; }
  .cal-legend .grad { display:inline-block; width:32px; height:10px; border-radius:999px; border:1px solid #e5e7eb; }
  .cal-legend .start { background:hsl(140 70% 95%); }
  .cal-legend .end { background:hsl(140 70% 40%); }

  @media (max-width: 920px){
    .layout { grid-template-columns: 1fr; }
    .side { order: -1; }
  }
  </style>
</head>
<body>
  <nav class="topnav">
    <div class="menu">
      <a href="{{ url_for('dashboard') }}">ğŸ  ë‚´ ë©”ë‰´</a>
      <div class="submenu">
        <a href="{{ url_for('profiles') }}">ğŸ‘¥ íŒ€ ìƒíƒœíŒ</a>
        <a href="{{ url_for('weekly') }}">ğŸ“… ì£¼ê°„ í˜„í™©íŒ</a>
        <a href="{{ url_for('monthly') }}">ğŸ“Š ì›”ê°„ í˜„í™©íŒ</a>
        <a href="{{ url_for('board') }}">ğŸ’¬ íŒ€ ê²Œì‹œíŒ</a>
        <a href="{{ url_for('change_password') }}">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
        <a href="{{ url_for('logout') }}">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
      </div>
    </div>
  </nav>

<div class="wrap">
  <div class="layout">
    <div class="main">
      <section class="hello-card">
        <div class="hello-top">ì•ˆë…•í•˜ì„¸ìš”</div>
        <div class="hello-name">
          <div>{{ username }}ë‹˜</div>
          {% if open_rec %}
            <div class="pill-status"><div class="pill-dot"></div><div>ê·¼ë¬´ì¤‘</div></div>
          {% else %}
            <div class="pill-status"><div class="pill-dot off"></div><div>í‡´ê·¼ìƒíƒœ</div></div>
          {% endif %}
        </div>
        <div class="hello-detail">
          {% if open_rec %}
            ì§€ê¸ˆ ê·¼ë¬´ì¤‘ì´ì—ìš”. ë¬´ì‚¬íˆ ë§ˆë¬´ë¦¬í•˜ê³  ì‰¬ëŠ” ì‹œê°„ ê¼­ ì±™ê¸°ê¸° âœ¨
          {% else %}
            ì˜¤ëŠ˜ì€ ì•„ì§ ì¶œê·¼ ì•ˆ í–ˆê±°ë‚˜ ì´ë¯¸ í‡´ê·¼í–ˆì–´ìš”. ì»¨ë””ì…˜ ì˜ ì±™ê¸°ê¸° ğŸŒ™
          {% endif %}
        </div>
      </section>

      <section class="stat-card">
        <div class="stat-header">
          <div class="stat-title">ì´ë²ˆë‹¬ ëˆ„ì  ê·¼ë¬´</div>
          <div class="stat-time">{{ month_hours }}ì‹œê°„ {{ month_mins }}ë¶„</div>
        </div>

        {% if open_rec %}
          <div>ğŸ•’ ì˜¤ëŠ˜ ì¶œê·¼: <strong>{{ open_rec.time_in }}</strong></div>
        {% else %}
          <div>ğŸ•’ í˜„ì¬ ì¶œê·¼ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤</div>
        {% endif %}

        <div class="punch-wrap">
          {% if open_rec %}
            <form method="post" action="{{ url_for('punch_out') }}">
              <button type="submit" class="punch-btn out">í‡´ê·¼í•˜ê¸°</button>
            </form>
          {% else %}
            <form method="get" action="{{ url_for('punch_form') }}">
              <button type="submit" class="punch-btn">ì¶œê·¼í•˜ê¸°</button>
            </form>
          {% endif %}
        </div>
      </section>

      <section class="lucky-card">
        <div class="lucky-head">
          <div class="lucky-title">ğŸ° ì˜¤ëŠ˜ì˜ ëŸ­í‚¤ ì´ë²¤íŠ¸</div>
          <div style="font-size:12px; color:#7e8099; font-weight:400;">1~5 ì¤‘ ì„œë¡œ ë‹¤ë¥¸ ìˆ«ì 3ê°œ</div>
        </div>
        <div>ë‚´ ì„ íƒ: {% if my_lucky_code %}<strong>{{ my_lucky_code }}</strong>{% else %}<span style="color:#7e8099;">(ì°¸ì—¬ ê¸°ë¡ ì—†ìŒ)</span>{% endif %}</div>
        {% if winning_code_today %}
          <div>ì˜¤ëŠ˜ì˜ ë‹¹ì²¨ ë²ˆí˜¸: <strong style="color:#4f6bed;">{{ winning_code_today }}</strong></div>
          {% if my_lucky_code %}
            {% if my_lucky_win %}
              <div style="color:#00a86b;">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì˜¤ëŠ˜ì˜ í–‰ìš´ ê·¼ë¬´ì!</div>
            {% else %}
              <div style="color:#7e8099;">ì˜¤ëŠ˜ì€ ì•„ì‰½ì§€ë§Œ ë‚´ì¼ ë‹¤ì‹œ ë„ì „ ğŸ’ª</div>
            {% endif %}
          {% else %}
            <div style="color:#7e8099;">ì˜¤ëŠ˜ì€ ì°¸ì—¬í•˜ì§€ ì•Šì•˜ì–´ìš”.</div>
          {% endif %}
        {% else %}
          <div style="color:#7e8099;">ë‹¹ì²¨ ë²ˆí˜¸ëŠ” 17:00 ì´í›„ ê³µê°œë©ë‹ˆë‹¤ ğŸ”’</div>
        {% endif %}
      </section>

      <section class="section-card">
        <div class="section-title">ë‚´ ë©”ë‰´</div>
        <div class="link-list">
          <div class="link-item"><a href="{{ url_for('profiles') }}">ğŸ‘¥<span>íŒ€ ìƒíƒœíŒ</span></a></div>
          <div class="link-item"><a href="{{ url_for('weekly') }}">ğŸ“…<span>ì£¼ê°„ í˜„í™©íŒ</span></a></div>
          <div class="link-item"><a href="{{ url_for('monthly') }}">ğŸ“Š<span>ì›”ê°„ í˜„í™©íŒ</span></a></div>
          <div class="link-item"><a href="{{ url_for('board') }}">ğŸ’¬<span>íŒ€ ê²Œì‹œíŒ</span></a></div>
          <div class="link-item"><a href="{{ url_for('change_password') }}">ğŸ”<span>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span></a></div>
          <div class="link-item"><a href="{{ url_for('logout') }}">ğŸšª<span>ë¡œê·¸ì•„ì›ƒ</span></a></div>
        </div>
        {% if is_admin %}
          <div style="font-size:11px; color:#7e8099; margin-top:8px;">ğŸ”§ ê´€ë¦¬ì ì „ìš©: <a href="{{ url_for('admin') }}" style="color:#4f6bed;">ê´€ë¦¬ì í˜ì´ì§€</a></div>
        {% endif %}
      </section>
    </div> <!-- /.main -->
    <aside class="side">
      <section class="calendar-card">
        <div class="cal-nav">
          <button id="cal-prev" class="cal-nav-btn" aria-label="ì´ì „ ë‹¬">â—€ï¸</button>
          <div id="cal-title" class="cal-title">YYYY.MM</div>
          <button id="cal-next" class="cal-nav-btn" aria-label="ë‹¤ìŒ ë‹¬">â–¶ï¸</button>
        </div>
        <div class="cal-weekdays">
          <span>ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span>
        </div>
        <div id="cal-grid" class="cal-grid"></div>
        <div class="cal-legend">
          <span class="grad start" title="0h"></span><span>0h</span>
          <span class="grad end" title="8h+"></span><span>8h+</span>
        </div>
      </section>
    </aside>
  </div> <!-- /.layout -->
  <div class="foot-note">Attendance System Â· local only</div>
</div>
<script>
(function(){
  const grid = document.getElementById('cal-grid');
  const title = document.getElementById('cal-title');
  const btnPrev = document.getElementById('cal-prev');
  const btnNext = document.getElementById('cal-next');

  let today = new Date();
  let curYear = today.getFullYear();
  let curMonth = today.getMonth(); // 0-based

  function fmtTitle(y, m0){ return `${y}.${String(m0+1).padStart(2,'0')}`; }

  function renderCalendar(){
    if (!grid) return;
    grid.innerHTML = '';
    if (title) title.textContent = fmtTitle(curYear, curMonth);

    const first = new Date(curYear, curMonth, 1);
    const last = new Date(curYear, curMonth + 1, 0);
    const startWeekday = first.getDay();
    const daysInMonth = last.getDate();

    // leading blanks
    for (let i=0; i<startWeekday; i++){
      const blank = document.createElement('div');
      blank.className = 'cal-cell blank';
      grid.appendChild(blank);
    }

    // day cells
    const cells = [];
    for (let d=1; d<=daysInMonth; d++){
      const cell = document.createElement('div');
      cell.className = 'cal-cell';
      const span = document.createElement('span');
      span.textContent = d;
      cell.appendChild(span);

      // weekend shading (Sun=0, Sat=6)
      const weekday = (startWeekday + (d-1)) % 7;
      if (weekday === 0 || weekday === 6) cell.classList.add('wknd');

      // today indicator
      if (curYear === today.getFullYear() && curMonth === today.getMonth() && d === today.getDate()){
        cell.classList.add('today');
      }

      grid.appendChild(cell);
      cells.push(cell);
    }

    // fetch data if API exists
    const url = `{{ url_for('api_monthly_work') }}?year=${curYear}&month=${curMonth+1}`;
    fetch(url)
      .then(r => r.ok ? r.json() : null)
      .then(data => {
        if (!data || !data.minutes) return;
        const minutes = data.minutes;
        const maxRef = 480; // 8h reference
        Object.keys(minutes).forEach(key => {
          const day = parseInt(key, 10);
          const mins = minutes[key] || 0;
          if (!Number.isFinite(day) || day < 1 || day > cells.length) return;
          const ratio = Math.max(0, Math.min(1, mins / maxRef));
          const hue = 140; // green
          const light = 95 - Math.round(55 * ratio); // 95% -> 40%
          const cell = cells[day-1];
          cell.style.background = `hsl(${hue} 70% ${light}%)`;
          cell.classList.add('worked');
          cell.title = `${(mins/60).toFixed(1)}h`;
        });
      })
      .catch(()=>{});
  }

  // navigation
  if (btnPrev) btnPrev.addEventListener('click', () => {
    curMonth -= 1;
    if (curMonth < 0){ curMonth = 11; curYear -= 1; }
    renderCalendar();
  });
  if (btnNext) btnNext.addEventListener('click', () => {
    curMonth += 1;
    if (curMonth > 11){ curMonth = 0; curYear += 1; }
    renderCalendar();
  });

  renderCalendar();
})();
</script>